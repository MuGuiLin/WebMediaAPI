<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    Web Audio API examples: createAnalyser() and getByteTimeDomainData()
  </title>
  <style>
    body {
      padding: 50px 100px;
    }

    p {
      font-size: 16px;
      line-height: 32px;
    }

    audio {
      margin: 30px 0;
      width: 500px;
    }

    select {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }

    input[type="range"] {
      /* transform: rotate(-90deg); */
    }

    #fftSize {
      width: 500px;
    }

    #column {
      width: 560px;
    }

    progress {
      width: 1288px;
    }
  </style>
</head>

<body>
  <h1>
    Web Audio API examples: createAnalyser() and getByteTimeDomainData()
  </h1>
  <hr />
  <p>
    <a target="_block"
      href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Audio_API/Visualizations_with_Web_Audio_API">åŸºäº Web
      Audio API å®ç°éŸ³é¢‘å¯è§†åŒ–æ•ˆæœ</a>
    ç½‘é¡µéŸ³é¢‘æ¥å£æœ€æœ‰è¶£çš„ç‰¹æ€§ä¹‹ä¸€å®ƒå°±æ˜¯å¯ä»¥è·å–é¢‘ç‡ã€æ³¢å½¢å’Œå…¶ä»–æ¥è‡ªå£°æºçš„æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥è¢«ç”¨ä½œéŸ³é¢‘å¯è§†åŒ–ã€‚
    <!--
      <br>è¦è·å–é¢‘ç‡æ•°æ®ï¼Œå¯ä½¿ç”¨ AnalyserNode.getByteFrequencyData() æˆ– AnalyserNode.getFloatFrequencyData() æ–¹æ³•ã€‚
      <br>è¦è·å–æ³¢å½¢æ•°æ®ï¼Œå¯ä½¿ç”¨ AnalyserNode.getByteTimeDomainData() æˆ– AnalyserNode.getFloatTimeDomainData() æ–¹æ³•ã€‚
      -->
  </p>

  æ·»åŠ æœ¬åœ°éŸ³è§†é¢‘ï¼š<input id="file" type="file" />

  <select id="select">
    <option value="">é¢‘ç‡ã€æ³¢å½¢ æ··åˆ</option>
    <option value="getByteFrequencyData">getByteFrequencyData é¢‘ç‡</option>
    <option value="getFloatFrequencyData">getFloatFrequencyData é¢‘ç‡</option>
    <option value="getByteTimeDomainData">getByteTimeDomainData æ³¢å½¢</option>
    <option value="getFloatTimeDomainData">
      getFloatTimeDomainData æ³¢å½¢
    </option>
  </select>

  <select id="filter">
    <option value="lowpass">lowpass - ä½é€šæ»¤æ³¢</option>
    <option value="highpass">highpass - é«˜é€šæ»¤æ³¢</option>
    <option value="bandpass">bandpass - å¸¦é€šæ»¤æ³¢</option>
    <option value="lowshelf">lowshelf - ä½æ¶æ»¤æ³¢</option>
    <option value="highshelf">highshelf - é«˜æ¶æ»¤æ³¢</option>
    <option value="peaking">peaking - å³°å€¼æ»¤æ³¢</option>
    <option value="notch">notch - æ ‡å‡†é™·æ³¢æ»¤æ³¢</option>
    <option value="allpass">allpass - æ ‡å‡†äºŒé˜¶å…¨é€šæ»¤æ³¢</option>
  </select>

  <br />
  <br />

  <div id="media">
    <!--
      <audio mute controls loop>
        <source src="./media/ç¨‹æ¬£-é‡æ¥.mp3" type="audio/mp3" />
        <source src="./media/hlbb.mp3" type="audio/mp3" />
      </audio>
      -->
    <video mute controls loop width="800">
      <source src="./media/ç¨‹æ¬£-é‡æ¥.mp3" type="audio/mp3" />
      <source src="./media/202107.mp4" type="video/mp4" />
    </video>
  </div>

  <br />
  <br />
  <br />
  <h4>ğŸ“ŠéŸ³é¢‘ä¿¡å·æ ·æœ¬</h4>
  ğŸªŸæ ·æœ¬çª—å£å¤§å°ï¼š<input type="range" id="fftSize" value="6" min="0" max="10" /> <b id="fftSizeNum">2048</b>
  <br />
  <br />
  <br />

  <h4>ğŸ”ŠéŸ³é¢‘å“åº¦</h4>
  <progress max="100" value="0" id="progress"></progress>
  <br />
  <br />
  <br />

  <h4>â™’ç¤ºæ³¢å™¨æ³¢å½¢æ•ˆæœ</h4>
  <canvas width="1288" height="300" id="canvas1"></canvas>
  <br />
  <br />
  <br />

  <h4>ğŸ“¶é¢‘ç‡æ¡å½¢å›¾æ•ˆæœ</h4>
  ğŸšï¸æ¡å½¢éŸ³æŸ±æ•°é‡ï¼š<input type="range" id="column" value="86" min="1" step="1" max="4096" /> <b id="columnNum">86</b>
  <br />
  <h5>æ¡å½¢æ•ˆæœ1ï¼š</h5>
  <canvas width="1288" height="300" id="canvas2"></canvas>
  <br />
  <h5>æ¡å½¢æ•ˆæœ2ï¼š</h5>
  <canvas width="1288" height="300" id="canvas3"></canvas>
  <br />
  <h5>æ¡å½¢æ•ˆæœ3ï¼š</h5>
  <canvas width="1288" height="300" id="canvas4"></canvas>

  <script>
    ; (function (global, factory) {
      'use strict';
      let isInit = true;
      document.onclick = function () {
        if (isInit) {
          isInit = false;
          factory(global);
          document.onclick = null;
        }
      };
    }(globalThis, function () {
      const ac = new (window.AudioContext || window.webkitAudioContext)();

      // const audio = new Audio("./media/hlbb.mp3");
      // const audio = document.querySelector("audio");
      const audio = document.querySelector("video");

      // åª’ä½“å…ƒç´ éŸ³æºå¯¹è±¡
      const source = ac.createMediaElementSource(audio); // ä»æ ‡ç­¾å…ƒç´  è·å–å£°æº
      // const source = ac.createMediaStreamSource(audio); // ä»éº¦å…‹é£ã€ç½‘ç»œè¯·æ±‚ è·å–å£°æº

      // åˆ†æå™¨
      let analyser = ac.createAnalyser();

      // æ»¤æ³¢å™¨
      const filterNode = ac.createBiquadFilter("lowpass");

      // å°†analyseråˆ†æå™¨èŠ‚ç‚¹ è¿æ¥åˆ° sourceéŸ³æºå¯¹è±¡
      source.connect(analyser);
      // å…³è”æœ€ç»ˆç›®æ ‡ç‚¹
      analyser.connect(ac.destination);

      // å°†filterNodeåˆ†æå™¨èŠ‚ç‚¹ è¿æ¥åˆ° sourceéŸ³æºå¯¹è±¡
      source.connect(filterNode);
      // å…³è”æœ€ç»ˆç›®æ ‡ç‚¹
      filterNode.connect(ac.destination);

      /*
        analyser.fftSize å±æ€§ç”¨äºè¡¨éŸ³é¢‘ä¿¡å·æ ·æœ¬çš„çª—å£å¤§å°ï¼Œå®ƒçš„å±æ€§å€¼æ˜¯æ— ç¬¦å·é•¿æ•´å‹ï¼Œå¹¶ä¸”å€¼è¯¥å¿…é¡»æ˜¯ä» 32 åˆ° 32768 ã€2^15ã€‘èŒƒå›´å†…ï¼ˆé»˜è®¤ä¸º2048ï¼‰çš„ 2 çš„éé›¶å¹‚ã€1ï¼Œ2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ 32â€¦â€¦ã€‘ï¼ˆå¦‚ä¸æ˜¯ 2 çš„å¹‚ï¼Œæˆ–è€…å®ƒåœ¨æŒ‡å®šèŒƒå›´ä¹‹å¤–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ INDEX_SIZE_ERR.ï¼‰; 
        analyser.fftSize = 2048; // analyser.fftSize é»˜è®¤(2048)
        analyser.fftSize = 1024; // analyser.frequencyBinCount é»˜è®¤(1024) 
      */

      // è·å–ArrayBufferæ•°æ®è§£æ
      let arrayBuffer = new Uint8Array(analyser.fftSize);
      let arrayBuffer2 = new Float32Array(analyser.fftSize);

      let rectSize = 86; // éŸ³æŸ±æ•°é‡

      const canvas1 = document.querySelector("#canvas1");
      const ctx1 = canvas1.getContext("2d");
      function animate1() {
        const width = (canvas1.width * 1.0) / analyser.fftSize;
        ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
        ctx1.beginPath();
        ctx1.lineWidth = 2;
        ctx1.strokeStyle = "#8C00FF";
        let x = 0;
        for (let i = 0; i < analyser.fftSize; i++) {
          const v = arrayBuffer[i] / 128.0;
          const y = (v * canvas1.height) / 2;
          if (0 === i) {
            ctx1.moveTo(x, y);
          } else {
            ctx1.lineTo(x, y);
          }
          x += width;

          progress.value = v * 10;
        }
        ctx1.stroke();
        ctx1.strokeStyle = "#31EDF8";
        ctx1.lineWidth = 1;
        ctx1.beginPath();
        ctx1.moveTo(0, canvas1.height / 2);
        ctx1.lineTo(canvas1.width, canvas1.height / 2);
        ctx1.stroke();
      };

      const canvas2 = document.getElementById('canvas2');
      const ctx2 = canvas2.getContext("2d");
      const grd = ctx2.createLinearGradient(0, 0, canvas2.height, 0); // å·¦å³æ¸å˜
      grd.addColorStop(0, "#00D0EE");
      grd.addColorStop(1, "#DDD");
      const rectWidth = 3;
      const rectHeight = 0;
      function animate2() {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        ctx2.beginPath();
        for (let i = 0; i < rectSize; i++) {
          const height = arrayBuffer[i];
          // const height = arrayBuffer[6 * i];
          ctx2.fillStyle = grd;
          ctx2.fillRect(i * 6, 300, rectWidth, -height + 1);
          // ctx2.fillRect(i * 6, 280 - height, rectWidth, rectHeight);
        }
      };

      const canvas3 = document.querySelector("#canvas3");
      const ctx3 = canvas3.getContext("2d");
      // å®šä¹‰ä¸Šä¸‹çº¿æ€§æ¸å˜çš„ä½ç½® å’Œ é¢œè‰²
      const fillStyle = ctx3.createLinearGradient(canvas3.width / 2, canvas3.height / 2 - 100, canvas3.width / 2, canvas3.height / 2 + 100);
      fillStyle.addColorStop(0, "#31EDF8");
      fillStyle.addColorStop(0.5, "#D620DB");
      fillStyle.addColorStop(1, "#A2F582");
      function animate3() {
        const rectWidth = 4;
        const width = canvas3.width;
        const height = canvas3.height;
        const space = Math.round(arrayBuffer.length / rectSize) / 2;
        ctx3.clearRect(0, 0, width, height);
        ctx3.fillStyle = fillStyle;
        for (let i = 0; i < rectSize; i++) {
          const ampli = arrayBuffer[i * space];
          ctx3.fillRect(width / 2 + i * 8, height / 2, rectWidth, ampli); // ä»ä¸­é—´å‘ä¸Šä¸‹ä¸¤è¾¹ç»˜åˆ¶
          ctx3.fillRect(width / 2 - i * 8, height / 2, rectWidth, ampli);
          ctx3.fillRect(width / 2 + i * 8, height / 2, rectWidth, -ampli);
          ctx3.fillRect(width / 2 - i * 8, height / 2, rectWidth, -ampli);
        }
      };

      const canvas4 = document.querySelector("#canvas4");
      const ctx4 = canvas4.getContext("2d");
      let rectArray = [];
      for (let i = 0; i < rectSize; i++) rectArray.push({ top: 0 });
      const linear = ctx4.createLinearGradient(0, 100, 0, canvas4.height); // ä¸Šä¸‹æ¸å˜
      linear.addColorStop(0, "red");
      linear.addColorStop(0.5, "yellow");
      linear.addColorStop(1, "green");

      function animate4() {
        ctx4.clearRect(0, 0, canvas4.width, canvas4.height);
        let width = canvas4.width / rectSize;
        for (let i = 0; i < rectSize; i++) {
          const height = arrayBuffer[i];
          const y = canvas4.height - height;
          const x = i * width + canvas4.width / 2;
          const x2 = canvas4.width / 2 - (i + 1) * width;

          ctx4.fillStyle = linear;
          ctx4.fillRect(x, y, width - 5, height);
          ctx4.fillRect(x2, y, width - 5, height);

          // éŸ³æŸ±é¡¶éƒ¨å°å—
          const o = rectArray[i];
          ctx4.fillStyle = "#7502d3";
          ctx4.fillRect(x, canvas4.height - (o.top + 12), width - 5, 8);
          ctx4.fillRect(x2, canvas4.height - (o.top + 12), width - 5, 8);

          o.top -= 3;
          if (o.top < 0) {
            o.top = 0;
          }
          if (height > 0 && o.top < height) {
            o.top = height;
          }
        }
      };

      let timer = null;
      let types = "";
      function render() {
        /*
        getByteTimeDomainData // ä¸€æ®µæ—¶é—´å†…ï¼›ç”¨äºâ€œç¤ºæ³¢å™¨â€å¯è§†åŒ–æ•°æ®å±•ç¤ºç­‰
          å¯ç”¨çº¿çŠ¶å›¾æ¥å¯è§†åŒ–TimeDomainæ•°æ®ï¼Œ
          å…¶ä¸­xè½´(ä¹Ÿå°±æ˜¯â€œåŸåŸŸâ€)æ˜¯æ—¶é—´ã€‚
          Yè½´æ˜¯ä¸€ä¸ªä¿¡å·çš„é‡åº¦(ä¹Ÿå°±æ˜¯â€œæŒ¯å¹…â€)ã€‚
        */

        /*
        getByteFrequencyData // ä¸€ä¸ªæ—¶é—´ç‚¹ï¼›ç”¨äºâ€œå‡è¡¡å™¨â€å¯è§†åŒ–æ•°æ®å±•ç¤ºç­‰
          å¯ç”¨æ¡å½¢å›¾æ¥å¯è§†åŒ–é¢‘ç‡æ•°æ®ã€‚
          å…¶ä¸­xè½´(åˆç§°â€œåŸŸâ€)æ˜¯é¢‘ç‡æˆ–é¢‘å¸¦ã€‚
          Yè½´æ˜¯æ¯ä¸ªé¢‘å¸¦çš„å¼ºåº¦ã€‚
        */
        // åå¤å°†æ”¶é›†åˆ°çš„å½“å‰éŸ³é¢‘æ—¶åŸŸé¢‘ç‡æ•°æ®å¤åˆ¶åˆ°ä¼ å…¥çš„ Uint8Arrayã€Float32Arrayï¼ˆæ— ç¬¦å·å­—èŠ‚æ•°ç»„ï¼‰ä¸­
        switch (types) {
          case "getByteFrequencyData":
            analyser.getByteFrequencyData(arrayBuffer);
            break;

          case "getFloatFrequencyData":
            // ç»™å‡ºäº†åº•éƒ¨çš„å›¾è¡¨(xè½´æ˜¯é¢‘ç‡);
            analyser.getFloatFrequencyData(arrayBuffer2);
            break;

          case "getByteTimeDomainData":
            analyser.getByteTimeDomainData(arrayBuffer);
            break;

          case "getFloatTimeDomainData":
            // ç»™å‡ºé¡¶éƒ¨çš„å›¾è¡¨(xè½´æ˜¯æ—¶é—´)
            analyser.getFloatTimeDomainData(arrayBuffer2);
            break;

          default:
            analyser.getByteTimeDomainData(arrayBuffer);
            analyser.getByteFrequencyData(arrayBuffer);
        };

        animate1();
        animate2();
        animate3();
        animate4();
        timer = requestAnimationFrame(render);
      };



      file.addEventListener("change", function () {
        const file = this.files[0];
        if ("video/mp4".startsWith("video")) {
          // video.src = window.URL.createObjectURL(file);
          audio.src = window.URL.createObjectURL(file);
        } else {
          audio.src = window.URL.createObjectURL(file);
        }
      });

      const fftSizeArray = [32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768];
      fftSize.oninput = function () {
        // for (let i = 0; 32768; i++) {
        //   if (i > 32768) return;
        //   if (0 < i && 0 === (i & (i - 1))) {
        //     console.log(i);
        //   }
        // }
        analyser.fftSize = fftSizeArray[this.value];
        fftSizeNum.innerText = fftSizeArray[this.value];
        arrayBuffer = new Uint8Array(analyser.fftSize);
        arrayBuffer2 = new Float32Array(analyser.fftSize);
      };

      column.oninput = function () {
        rectSize = this.value;
        columnNum.innerText = this.value;
        rectArray = [];
        for (let i = 0; i < rectSize; i++) rectArray.push({ top: 0 });
      };

      select.addEventListener("change", function (event) {
        types = this.value;
      });

      filter.addEventListener("change", function () {
        filterNode.type = this.value;
      });

      audio.addEventListener("play", function (event) {
        render();
      });

      audio.addEventListener("ended", function (event) {
        cancelAnimationFrame(timer);
      });

      audio.addEventListener("pause", function (event) {
        cancelAnimationFrame(timer);
      });

    }));
  </script>
</body>

</html>