<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script async src="//hm.baidu.com/hm.js?f79493fc378b2235419a88daa91d5f6d"></script>
  <title>Webå‰ç«¯JSå¦‚ä½•è·å– Video/Audio è§†éŸ³é¢‘å£°é“(å·¦å³å£°é“|å¤šå£°é“)ã€è§†éŸ³é¢‘è½¨é“ã€éŸ³é¢‘æµæ•°æ®</title>
  <style>
    body {
      padding: 50px;
    }

    h1 {
      text-align: center;
    }

    section {
      margin: 100px auto;
      width: 1200px;
    }

    audio,
    input[type="file"] {
      width: 471px;
    }

    meter {
      width: 128px;
      transform: rotate(-90deg);
    }

    label {
      position: relative;
    }

    #TBLV {
      position: absolute;
      top: 80px;
      right: 30px;
    }

    #TBRV {
      position: absolute;
      top: 80px;
      left: 30px;
    }

    button {
      font-size: 16px;
    }
  </style>
</head>

<body>
  <h1>Webå‰ç«¯JSå¦‚ä½•è·å– Video/Audio è§†éŸ³é¢‘å£°é“(å·¦å³å£°é“|å¤šå£°é“)ã€è§†éŸ³é¢‘è½¨é“ã€éŸ³é¢‘æµæ•°æ®</h1>
  <hr />

  <section>
    <label>
      <button type="button" id="LBTN">å·¦å£°é“ï¼ˆLï¼‰</button>
      <meter id="L" min="-60" low="-20" high="-6" max="3" value="-60" style="margin-left: 13px"></meter>
      <span id="TBLV">å³°å€¼ç”µå¹³ï¼š-60</span>
    </label>
    æ·»åŠ æœ¬åœ°è§†éŸ³é¢‘ï¼š<input id="file" type="file" accept="video/*,audio/*" />
    <label>
      <meter id="R" min="-60" low="-20" high="-6" max="3" value="-60"></meter>
      <span id="TBRV">å³°å€¼ç”µå¹³ï¼š-60</span>
      <button type="button" id="RBTN">å³å£°é“ï¼ˆRï¼‰</button>
    </label>
    <br /><br />

    <div class="box">
      <button type="button" id="SLBTN">å·¦ç¯ç»•ï¼ˆSLï¼‰</button>
      <meter id="SL" min="-60" low="-20" high="-6" max="3" value="-60"></meter>

      <!--<audio  controls loop width="600">
          <source src="./media/xxx.mp3" type="audio/mp3" />
        </audio>-->
      <video controls width="600">
        <source src="./media/Project DT-5.1.mp4" type="video/mp4" />
      </video>

      <meter id="SR" min="-60" low="-20" high="-6" max="3" value="-60"></meter>
      <button type="button" id="SRBTN">å³ç¯ç»•ï¼ˆSRï¼‰</button>
    </div>
  </section>
  <br><br><br>
  <a href="https://blog.csdn.net/muguli2008/article/details/134762971" target="_blank">ğŸš€äº†è§£æ›´å¤šï¼</a>

  <script>
    // è·å–æœ¬åœ°è§†éŸ³é¢‘
    file.addEventListener("change", function () {
      const file = this.files[0];
      console.log(file);
      if ("video/mp4".startsWith("video")) {
        // video.src = window.URL.createObjectURL(file);
        audio.src = window.URL.createObjectURL(file);
      } else {
        audio.src = window.URL.createObjectURL(file);
      }
    });

    // è®¡ç®—éŸ³é¢‘logå¯¹æ•°
    function getBaseLog(x, y) {
      return Math.log(y) / Math.log(x);
    };

    // è®¡æ•°å³°å€¼ç”µå¹³
    function countPeakLevel(float) {
      return getBaseLog(10, float) * 20;
    };

    // æå–å£°è½¨å¹¶è®¡ç®—æœ€å¤§å€¼
    function countMaxValue(buffer) {
      const channels = [], { numberOfChannels } = buffer;
      for (let i = 0; i < numberOfChannels; i += 1) {
        channels[i] = 0.0;
        const channelData = buffer.getChannelData(i);
        for (let j = 0; j < channelData.length; j += 1) {
          (Math.abs(channelData[j]) > channels[i]) && (channels[i] = Math.abs(channelData[j]));
        }
      }
      return channels;
    };

    // const audio = document.querySelector("audio");
    const audio = document.querySelector("video");
    let ac = null;

    // éŸ³é¢‘å…ƒæ•°æ®åŠ è½½åæ‰§è¡Œ
    audio.addEventListener("loadedmetadata", () => {
      if (!ac) {
        // ä¸Šä¸‹æ–‡å¯¹è±¡ ç”±äºæµè§ˆå™¨å®‰å…¨ç­–ç•¥è¦æ±‚éŸ³é¢‘ä¸Šä¸‹æ–‡å¿…é¡»åœ¨ç”¨æˆ·äº‹ä»¶ï¼ˆå•å‡»ã€é”®ç›˜æŒ‰é”®ç­‰ï¼‰ä¸­å¯ç”¨ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ‚¨å°è¯•åœ¨æ²¡æœ‰ç”¨æˆ·äº‹ä»¶çš„æƒ…å†µä¸‹è‡ªåŠ¨æ’­æ”¾éŸ³ä¹ï¼Œæ‰€ä»¥åœ¨loadedmetadataå…ƒæ•°æ®å·²åŠ è½½æ—¶å†æ‰§è¡Œï¼ï¼
        ac = new (window.AudioContext || window.webkitAudioContext)();

        // åˆ›å»ºå¹¶è·å–è¾“å…¥æº
        const audioSource = ac.createMediaElementSource(audio);
        // ç¼“å†²åŒºå¤§å° å–å€¼ä¸º 2 çš„å¹‚æ¬¡æ–¹çš„ä¸€ä¸ªå¸¸æ•°
        const bufferSize = 2048;
        // éŸ³é¢‘é€šé“æ•° é»˜è®¤å€¼æ˜¯ 2ï¼Œæœ€é«˜èƒ½å– 32
        const channelCount = 4 || audioSource.channelCount;

        // åˆ›å»ºéŸ³é¢‘å¤„ç†å™¨
        const processor = ac.createScriptProcessor(bufferSize, channelCount, channelCount);
        // é“¾æ¥éŸ³é¢‘å¤„ç†å™¨
        audioSource.connect(processor).connect(ac.destination);
        // é“¾æ¥åˆ°æ‰¬å£°å™¨
        audioSource.connect(ac.destination);

        audio.play();

        const L = document.querySelector('#L')
        // ç›‘å¬éŸ³é¢‘å¤„ç†å™¨æ¯æ¬¡å¤„ç†çš„æ ·æœ¬å¸§
        processor.onaudioprocess = (evt) => {
          // console.log("éŸ³é¢‘é€šé“æ•°ï¼š", evt.inputBuffer.numberOfChannels);

          //è·å–å£°è½¨1è¾“å…¥çš„ç¼“å†²åŒºæ•°æ®
          // evt.inputBuffer.getChannelData(0);

          //è·å–å£°è½¨1è¾“å‡ºçš„ç¼“å†²åŒºæ•°æ®
          // evt.outputBuffer.getChannelData(0);

          const [l, r, sl, sr] = countMaxValue(evt.inputBuffer);

          // å£°è½¨1
          if (l) {
            L.value = countPeakLevel(l);
            TBLV.innerText = 'å³°å€¼ç”µå¹³ï¼š' + L.value.toFixed(2);
          }
          // å£°è½¨2
          if (r) {
            R.value = countPeakLevel(r);
            TBRV.innerText = 'å³°å€¼ç”µå¹³ï¼š' + R.value.toFixed(2);
          }
          // å£°è½¨3
          if (sl) {
            SL.value = countPeakLevel(sl);
          }
          // å£°è½¨4
          if (sr) {
            SR.value = countPeakLevel(sr);
          }

          /*
            {
              // å£°è½¨1 éå†æ ·æœ¬å¸§æ•°ç»„ï¼Œæ€§èƒ½å·®ï¼Œä½†å³°å€¼ç”µå¹³è·³è¡¨æ›´å‡†ç¡®
              let input = evt.inputBuffer.getChannelData(0),
                len = input.length,
                i = 0;
              while (i < len) {
                const level = countPeakLevel(input[i++]);
                if (level) {
                  L.value = level;
                  TBLV.innerText = 'å³°å€¼ç”µå¹³ï¼š' + L.value.toFixed(2);
                }
              }
            };

            {
              // å£°è½¨2 (ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œä¸å®æ—¶è®¡ç®—ï¼Œåªå–æ ·æœ¬å¸§æ•°ç»„æœ€å¤§çš„å€¼)ï¼Œæ¨è
              const input = evt.inputBuffer.getChannelData(1);
              R.value = countPeakLevel(Math.max(...input));
              TBRV.innerText = 'å³°å€¼ç”µå¹³ï¼š' + R.value.toFixed(2);
            };

            {
              // å£°è½¨3 (ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œä¸å®æ—¶è®¡ç®—ï¼Œåªå–ç¬¬1ä¸ªæ ·æœ¬å¸§è®¡ç®—ä¸€æ¬¡)
              const input = evt.inputBuffer.getChannelData(2);
              if (input[0]) {
                SL.value = countPeakLevel(input[0]);
              }
            };

            {
              // å£°è½¨4 (ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œä¸å®æ—¶è®¡ç®—ï¼Œåªå–ä¸­é—´çš„è®¡ç®—ä¸€æ¬¡)
              const input = evt.inputBuffer.getChannelData(3);
              if (input[input.length / 2]) {
                SR.value = countPeakLevel(input[input.length / 2]);
              }
            };
          */
        };
      } else {
        audio.play();
      };
    }, false);

    // ç›‘å¬éŸ³é¢‘æ’­æ”¾æ—¶ï¼Œæ¿€æ´»å½“å‰æ’­æ”¾
    audio.addEventListener('play', () => {
      ac.resume();
    }, false);

    // ç›‘å¬éŸ³é¢‘æš‚åœæ—¶ï¼ŒæŒ‚èµ·å½“å‰æ’­æ”¾
    audio.addEventListener('pause', () => {
      ac.suspend();
    }, false);

  </script>
</body>

</html>